name: Deployment

on:
    workflow_run:
        workflows: ['Node.js CI']
        branches: [main]
        types:
            - completed

jobs:
    deploy:
        environment: main
        if: ${{ github.event.workflow_run.conclusion == 'success' }}
        runs-on: ubuntu-latest
        steps:
            - name: Download frontend build files
              uses: actions/download-artifact@v3
              with:
                  name: build-frontend
                  path: frontend

            - name: Download frontend build files
              uses: actions/download-artifact@v3
              with:
                  name: build-backend
                  path: backend

            - name: Add SSH key
              env:
                  SSH_KEY: ${{ secrets.SSH_KEY }}
              run: mkdir -p ~/.ssh && printf "%s" "$SSH_KEY" > ~/.ssh/id_rsa && chmod 600 ~/.ssh/id_rsa

            - name: Add host to known_hosts
              run: echo "|1|51Fg/gQzqNfhMkuBnxLBSWCrl+s=|TbUOHEmNxVDTGdkxvvlmlN761QM= ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBMV0unNHDl5cqDEDYe5ADTCgXMZxr02k5M4mcI9gFPtlrUiDjlE0UTZ8ejgPWhILtK3iETzNb8FD53dMn6Ck/vQ=" >> ~/.ssh/known_hosts

            - name: Copy frontend files to server
              run: rsync --recursive --verbose --chmod=755 frontend/ root@65.108.249.101:/srv/http

            - name: Change ownership for frontend files
              run: ssh root@65.108.249.101 "chown -R www-data:www-data /srv/http"

            - name: Copy backend files to server
              run: rsync --recursive --verbose --chmod=755 backend/ root@65.108.249.101:/home/app/live

            - name: Change ownership for backend files
              run: ssh root@65.108.249.101 "chown -R app:app /home/app/live"

            - name: Restart backend service
              run: ssh root@65.108.249.101 "systemctl restart aalto_2022_backend.service"
